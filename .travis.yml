sudo: required
language: java
jdk:
  - openjdk11
services:
  - docker
cache:
  directories:
    - $HOME/.m2
env:
  global:
    # AWS_ACCESS_KEY_ID
    - secure: "jL6lSdTFVOe+GH9lRRhYsW1VAigbdkVan7dj8SmBYxN+AB0egl0R7z6xHH6F/i2FS9QHj2ViOloUDHdtVlsnTcgoAIPvrDbf4aMq9QIktrwC1N8i6cMTYZJBzg7K99F/rGw9Yw7lBIJ0vbjuU3gfu24mTQ4x3dErSdw0wYdxW32QHX0X+7ehfg8j+u0g2gwIDJ6uTijt2VS8whFE1is+pwjCT41IUKrual6mhXIJH+Dv2khn2zxVb8FLEzc6hDPB1j5J112o8r0yMVbw+4TQJYXuNxAe83eGWVDigH6jqvtt1bRrLcm7/raxbfa8bWCBeNCHzSMcY6wRWXfU8sLp1OZGlTzYaZMKzdUNlWWtNVUDCM88pjXxl9eaSbfFO1K9pyX9sLDO9XrmxhnzeWoMDqwOlav+jDgA6nDoT7w5M96a1iUe9CrolTAC+6cDlPTAUnjy4Y/L8hHuGcIx/FG7Y242qHK1eDecZKDGo4Ro16nn/Z7q+bLSyyqe1dpeTplIC//ZXNYZezVjT+YoVO63oiEaD6aOyNiz6cQoUR+DMJnEyDe/ZIzfJ2ldDOXpbPvRGWmRW/oUPvsEiluTdTqhHDPKvAGPZuVTcJs+GfSFz+HF5oq5k0rFloGfCtdNAhAuYGt+7vntjxyS3puAMaIL0rsPo0iduJy3Bvf4bheJhHA="
    # AWS_SECRET_ACCESS_KEY
    - secure: "GHNNf2Y2b3ys/ikuI6esWpfMpOCEHpcv1XtgfypHWFlK5uL7ClA3HGiuGbVZycRJHjCMgg8b9DvZHZlQ5vM9z1ug1nDkuS7/30TXmpqKajiKz2vIL7ZRI0eDmL+aTOw3JUgGvSPRkvWWkkkp3W4Tqo2fwjFKnQ39o699ik+mRzFekTsptvG8VcEcMUTgv3/q7Six1KtEABS+0JcZypc0mJKmmDqoH5yVSkOgx9bIbO2oVgUGInUCAsTHCwoierLwy/86mBWgnT4oWA22eUlYNct4/Fd+Tb0UhRgikDgFFGt1QAEcKjoHwrgOH3zfkLDGzKqLJNslO7nKzQqaJctUetfBHigv0idYZyah6AHymkEfj8PVHRCUjB6PSUrCalVoZgXh3ucoPtQ6NZy3Ib1FS+0hfO5RpFUN2rVHObblhbWnLuonAiLIyFKx/zj5GaWwZMI7laTgy3LtxZmud2eC0C3cLbdlFE/q9I0fn0LkHB0WUwBITs7D4RECk6VDKluc+8KWLkKChROjEGBEHjeg7h/g/A01TZVz7reil9c9zTjYdXIkDj8btlY4YnAAPg9L0EOHybQdgXMh/EsqLj07WQa2wRoia+2XaMlIcTD3ALAVhGqTfk3b4Y+s0fZH6n6kk0aKqd2F1uiI24tG8XeQcEOZNyCa6zza0//U7molPZ4="

install:
  - git clone https://github.com/Opetushallitus/ci-tools.git
  - source ci-tools/common/setup-tools.sh
  - export ARTIFACT_NAME="oikeustulkkirekisteri"

script:
  - mvn clean install -B -Dbranch=${TRAVIS_BRANCH} -Drevision=${TRAVIS_COMMIT} -DbuildNumber=${TRAVIS_BUILD_NUMBER}

  - mv oikeustulkkirekisteri-service/target/oikeustulkkirekisteri-service.war $DOCKER_BUILD_DIR/artifact/oikeustulkkirekisteri-service.war
  - mv oikeustulkkirekisteri-ui/target/oikeustulkkirekisteri-ui-*.war $DOCKER_BUILD_DIR/artifact/oikeustulkkirekisteri-ui.war
  - mv oikeustulkkirekisteri-public-ui/target/oikeustulkkirekisteri-public-ui-*.war $DOCKER_BUILD_DIR/artifact/oikeustulkkirekisteri-public-ui.war
  - cp -vr src/main/resources/oph-configuration $DOCKER_BUILD_DIR/config/

  - export BASE_IMAGE="baseimage-war-openjdk11:master"
  - ./ci-tools/common/pull-image.sh
  - ./ci-tools/build/build-war.sh $ARTIFACT_NAME

deploy:
  - provider: script
    script: ./ci-tools/build/upload-image.sh $ARTIFACT_NAME
    on:
      all_branches: true
