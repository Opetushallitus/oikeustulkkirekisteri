sudo: required
language: java
jdk:
  - openjdk11
services:
  - docker
cache:
  directories:
    - $HOME/.m2
env:
  global:
    # AWS_ACCESS_KEY_ID
    - secure: "Cctl82Vvq6ts6zyfTpq27cAUVXp4X2mjbCiAm7tUnPveJQuDf/RVHVGT7jr5a90HXbcey5tU/kei1qTOTWBfxwcStl5GdFTQFzGnEDw33z3TOpD7Cw8FnRAFkK3arHvqiFgzJWu4MKgJgdeScpOklIyTR8uHWWLxR6sX8CcozyxHQ8Y4NMaXp2T3mUGueyYkQWa2zEgpx3zEbh2YpQNLGRL0IOT2obaA7w4LvzlejHDivLIMrvLsTLTTqwB09k/OnRcGiwIR7ZOzpzIYifPBZdG5gcMONpsE4G6IThIqYxS9rURsIsASCPWy+nFkHPHxFCUvQDB3PunIatU+imoEpLwSg9GUSuMAyIkUIhRphJM1SCxFx/+dCoAq+FCXNn60av9XBsgAIUbjfgozjzfcqf7kL9TiRjWMMD7X1dUGbMds/OM9vkAbMa2CSCWwmT4hg6Q19lsCSdcjCuS6FUcVwkjGcTELplx3MVCX0VhFrQixAE1ZMi6jndcuAAX7KgfxdL/srMRLZ88wcq79KoZZaIQqpddJ8dkZxXCI5qek/MbVr0+EWlFNdy3TsAk6lMn2JXNfHBQgXrWLSVhmD4i11BLYJ287+odTvRr9Z3X5XI3RxAc8fqZijHNKXmNs7BbqdUf/Ld8LRvKep7A1bS9786YnjjPkNz8WwG2JmduUQJI="
    # AWS_SECRET_ACCESS_KEY
    - secure: "rHsvCGlVvYvzpXzG+634nfOPlbriiPMPvaZUvdNUO+2UAxcCh7IHBR5wEV+LZX/JqjOk2QzFq2wFH3Wt7iXlCwrLEROS7XW7HByFeShjYig32Yc8svvokNtJjKUMwqWvX+pfipK9JpyhTbRt2at8JhpftMDNBP13xyB/KqneuI0hfzLCiJA8N48XV9pyY/Uf5+OtziY3iajbb7kDakWY+6fSZbz7lRPvZkpAyJnWrrVAcsnxDUj3dcoDfahjbHjHwnhmiclUS7ebfRr0jzwImemoax4axc1cMvstv6oRTM+VuVpKPpAiVs+8lrE1heH42VaJVIxhTwLvnF+U03OSmm/EcG0Onix/Xzt5T/IQ3lbZSZLM/dOBQTKOzJtYSTaKpQZcFO1JX4wog7cP9SduMA8CILTMRT/DToty9XYpNDDvVnr1GJ9oeFEcglL1tq5ciFJXEsvAd32wAfLCo+fzGSajb6IMdSQs9VXJ5jm3B+ED/pO0FthjknlfPSTxcVLOgDsw7uqVPfXD1BM0iJ0/XLS098NrIs+YlPEMh/4FtZjToJ+/eyrSsRaA8Z8S2lKbnprgcEZ3BZuYOAJDy27vP1+tf3MhTH/NchF7MC/gmRgEWjkpfTrktF7bWD5pNbCTkGkwZ06IJQs81YGn2FG+qL6es4VDPUJBv79IbINffWw="

install:
  - git clone https://github.com/Opetushallitus/ci-tools.git
  - source ci-tools/common/setup-tools.sh
  - export ARTIFACT_NAME="oikeustulkkirekisteri"

script:
  - mvn clean install -B -Dbranch=${TRAVIS_BRANCH} -Drevision=${TRAVIS_COMMIT} -DbuildNumber=${TRAVIS_BUILD_NUMBER}

  - mv oikeustulkkirekisteri-service/target/oikeustulkkirekisteri-service.war $DOCKER_BUILD_DIR/artifact/oikeustulkkirekisteri-service.war
  - mv oikeustulkkirekisteri-ui/target/oikeustulkkirekisteri-ui-*.war $DOCKER_BUILD_DIR/artifact/oikeustulkkirekisteri-ui.war
  - mv oikeustulkkirekisteri-public-ui/target/oikeustulkkirekisteri-public-ui-*.war $DOCKER_BUILD_DIR/artifact/oikeustulkkirekisteri-public-ui.war
  - cp -vr src/main/resources/oph-configuration $DOCKER_BUILD_DIR/config/

  - export BASE_IMAGE="baseimage-war-openjdk11:master"
  - ./ci-tools/common/pull-image.sh
  - ./ci-tools/build/build-war.sh $ARTIFACT_NAME

deploy:
  - provider: script
    script: ./ci-tools/build/upload-image.sh $ARTIFACT_NAME
    on:
      all_branches: true
